name: Hatch Release CI
on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 2.0.0)'
        required: true
        default: '2.0.0'

jobs:
  build:
    name: Build
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checksum
        shell: pwsh
        run: |
          echo "SOURCE_NETCH_SHA256=$(.\sha256.ps1 .\Netch)" | Out-File -Append -Encoding UTF8 -FilePath $Env:GITHUB_ENV
          echo "SOURCE_OTHER_SHA256=$(.\sha256.ps1 .\Other)" | Out-File -Append -Encoding UTF8 -FilePath $Env:GITHUB_ENV
          echo "SOURCE_REDIRECTOR_SHA256=$(.\sha256.ps1 .\Redirector)" | Out-File -Append -Encoding UTF8 -FilePath $Env:GITHUB_ENV
          echo "SOURCE_ROUTEHELPER_SHA256=$(.\sha256.ps1 .\RouteHelper)" | Out-File -Append -Encoding UTF8 -FilePath $Env:GITHUB_ENV

      - name: Cache Netch
        uses: actions/cache@v5
        with:
          key: Hatch-${{ runner.os }}-Netch-${{ env.SOURCE_NETCH_SHA256 }}
          path: |
            .\Netch\bin

      - name: Cache Redirector
        uses: actions/cache@v5
        with:
          key: Hatch-${{ runner.os }}-Redirector-${{ env.SOURCE_REDIRECTOR_SHA256 }}
          path: |
            .\Redirector\bin

      - name: Cache RouteHelper
        uses: actions/cache@v5
        with:
          key: Hatch-${{ runner.os }}-RouteHelper-${{ env.SOURCE_ROUTEHELPER_SHA256 }}
          path: |
            .\RouteHelper\bin

      - name: Check Other
        id: check_other
        uses: andstor/file-existence-action@v3
        with:
          files: .\Other\release\aiodns.bin

      - name: Setup Go
        uses: actions/setup-go@v5
        if: steps.check_other.outputs.files_exists == 'false'
        with:
          go-version: '1.22'

      - name: Setup C++
        uses: msys2/setup-msys2@v2
        if: steps.check_other.outputs.files_exists == 'false'
        with:
          update: true
          release: true
          install: base-devel git mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-libevent mingw-w64-x86_64-pcre2 mingw-w64-x86_64-freetype mingw-w64-x86_64-libpng mingw-w64-x86_64-bzip2 mingw-w64-x86_64-openssl mingw-w64-x86_64-mbedtls mingw-w64-x86_64-libsodium mingw-w64-x86_64-c-ares mingw-w64-x86_64-boost mingw-w64-x86_64-libmariadbclient unzip p7zip autoconf automake libtool

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        if: steps.check_other.outputs.files_exists == 'false'
        with:
          toolchain: nightly
          profile: minimal

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2.0.0

      - name: Build
        shell: pwsh
        run: |
          .\build.ps1 -Configuration Release -OutputPath release

      - name: Package 7z
        shell: pwsh
        run: |
          7z a -mx9 Hatch.7z release
          7z rn Hatch.7z release Hatch

      - name: Package Zip
        shell: pwsh
        run: |
          Compress-Archive -Path release -DestinationPath Hatch.zip -CompressionLevel Optimal
          
      - name: Checksum
        shell: pwsh
        run: |
          $hash7z=(Get-FileHash Hatch.7z -Algorithm SHA256).Hash.ToLower()
          $hashZip=(Get-FileHash Hatch.zip -Algorithm SHA256).Hash.ToLower()
          echo "HATCH_7Z_SHA256=$hash7z" | Out-File -Append -Encoding UTF8 -FilePath $Env:GITHUB_ENV
          echo "HATCH_ZIP_SHA256=$hashZip" | Out-File -Append -Encoding UTF8 -FilePath $Env:GITHUB_ENV

      - name: Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          prerelease: ${{ contains(github.ref, '-') }}
          draft: false
          files: |
            Hatch.7z
            Hatch.zip
          body: |
            # Hatch v${{ github.ref_name }}
            
            åŸºäº Netch 1.9.7 ç»§ç»­å¼€å‘çš„åˆ†æ”¯ç‰ˆæœ¬ | A fork based on Netch 1.9.7
            
            ## ğŸ“¦ ä¸‹è½½ | Downloads
            
            - **Hatch.7z** - 7-Zip å‹ç¼©åŒ… (æ¨èï¼Œä½“ç§¯æ›´å°)
            - **Hatch.zip** - ZIP å‹ç¼©åŒ… (å…¼å®¹æ€§æ›´å¥½)
            
            ## âœ¨ æ›´æ–°æ—¥å¿— | Changelogs
            
            * è¿™æ˜¯ GitHub Actions è‡ªåŠ¨åŒ–éƒ¨ç½²
            * åŸºäº Netch 1.9.7 é¡¹ç›®ç»§ç»­å¼€å‘
            * é›†æˆ Xray-core æœ€æ–°ç‰ˆæœ¬
            * ä¼˜åŒ–æ„å»ºä½“ç§¯ (å‡å°‘ 56.8%)
            * æ”¹è¿› UI ç•Œé¢å’Œå»¶è¿Ÿæ˜¾ç¤º
            * Hysteria2 åè®®ä¼˜åŒ–
            
            ## ğŸ” æ ¡éªŒå’Œ | Checksums
            
            | æ–‡ä»¶å | SHA256 |
            | :- | :- |
            | Hatch.7z | ${{ env.HATCH_7Z_SHA256 }} |
            | Hatch.zip | ${{ env.HATCH_ZIP_SHA256 }} |
            
            ## ğŸ“– ä½¿ç”¨è¯´æ˜ | Documentation
            
            è¯·æŸ¥çœ‹ [README.md](https://github.com/OffroadOps/Hatch/blob/main/README.md) è·å–è¯¦ç»†ä½¿ç”¨è¯´æ˜ã€‚
            
            ---
            
            **æ³¨æ„**: æœ¬å·¥å…·ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œä½¿ç”¨è€…éœ€éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ã€‚
